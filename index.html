<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esta√ß√£o de Jogos de Fra√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #1a202c;
            color: #e2e8f0;
        }
        .game-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }
        .player-piece { transition: all 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .btn { transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .option-card:hover { transform: scale(1.05); border-color: #63b3ed; }
        
        /* Anima√ß√£o do Dado */
        .dice-container { perspective: 1000px; }
        .dice { width: 60px; height: 60px; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .dice-face { position: absolute; width: 60px; height: 60px; background: #f7fafc; border: 2px solid #2d3748; font-size: 30px; color: #1a202c; display: flex; align-items: center; justify-content: center; font-weight: bold; opacity: 0.9; }
        .face-1 { transform: rotateY(0deg) translateZ(30px); }
        .face-2 { transform: rotateY(90deg) translateZ(30px); }
        .face-3 { transform: rotateY(180deg) translateZ(30px); }
        .face-4 { transform: rotateY(-90deg) translateZ(30px); }
        .face-5 { transform: rotateX(90deg) translateZ(30px); }
        .face-6 { transform: rotateX(-90deg) translateZ(30px); }
        
        /* Batalha */
        .hp-bar-container { background-color: #4a5568; border-radius: 9999px; overflow: hidden; }
        .hp-bar { transition: width 0.5s ease-in-out; }
        .character { transition: transform 0.2s ease-in-out; }
        .character-attack { transform: scale(1.1) rotate(-5deg); }
        .character-hit { animation: shake 0.5s; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .game-board-bg {
            background: #2d3748;
            background-image:
                linear-gradient(rgba(255, 255, 255, .07) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, .07) 2px, transparent 2px),
                linear-gradient(rgba(255, 255, 255, .06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, .06) 1px, transparent 1px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            background-position: -2px -2px, -2px -2px, -1px -1px, -1px -1px;
        }
        /* Calculadora Ninja Feedback */
        .correct-answer { animation: flash-green 0.5s; }
        @keyframes flash-green {
            from { background-color: #2f855a; }
            to { background-color: #2d3748; }
        }
        .wrong-answer { animation: flash-red 0.5s; }
        @keyframes flash-red {
            from { background-color: #c53030; }
            to { background-color: #2d3748; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-5xl mx-auto">

        <!-- TELA DE LOGIN -->
        <div id="login-screen" class="bg-gray-800 p-8 rounded-2xl shadow-2xl text-center">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">Esta√ß√£o de Jogos de Fra√ß√µes</h1>
            <p class="text-gray-400 mb-6">Digite seu nome para continuar!</p>
            <input type="text" id="player-name-input" placeholder="Seu Nome Aqui" class="w-full max-w-sm mx-auto bg-gray-700 border-2 border-gray-600 text-white text-center text-lg rounded-lg p-3 mb-6 focus:outline-none focus:border-blue-500 transition-colors">
            <button id="login-btn" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">Entrar</button>
            <button id="show-ranking-btn-login" class="mt-4 text-gray-400 hover:text-white">Ver Ranking Geral</button>
        </div>
        
        <!-- TELA DE MENU PRINCIPAL -->
        <div id="main-menu-screen" class="hidden">
            <h1 id="welcome-message" class="text-3xl font-bold text-center mb-8"></h1>
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Aventura das Fra√ß√µes -->
                <div id="start-tabuleiro" class="game-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border-2 border-gray-700 hover:border-blue-500">
                    <h2 class="text-2xl font-bold text-blue-400">Aventura das Fra√ß√µes</h2>
                    <p class="mt-2 text-gray-400">Jogue o dado e avance no tabuleiro respondendo a perguntas visuais.</p>
                </div>
                <!-- Calculadora Ninja -->
                <div id="start-calculadora" class="game-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border-2 border-gray-700 hover:border-green-500">
                    <h2 class="text-2xl font-bold text-green-400">Calculadora Ninja</h2>
                    <p class="mt-2 text-gray-400">Resolva o m√°ximo de opera√ß√µes em 60 segundos!</p>
                </div>
                <!-- Batalha das Fra√ß√µes -->
                <div id="start-batalha" class="game-card bg-gray-800 p-6 rounded-lg text-center cursor-pointer border-2 border-gray-700 hover:border-red-500">
                    <h2 class="text-2xl font-bold text-red-400">Batalha das Fra√ß√µes</h2>
                    <p class="mt-2 text-gray-400">Derrote o monstro acertando as quest√µes de fra√ß√µes!</p>
                </div>
            </div>
            <div class="text-center">
                <button id="logout-btn" class="mt-12 text-gray-500 hover:text-white">Sair</button>
            </div>
        </div>

        <!-- TELA DO JOGO DE TABULEIRO -->
        <div id="tabuleiro-screen" class="hidden"></div>
        
        <!-- TELA DA CALCULADORA NINJA -->
        <div id="calculadora-screen" class="hidden"></div>

        <!-- TELA DA BATALHA DAS FRA√á√ïES -->
        <div id="batalha-screen" class="hidden"></div>
        
        <!-- TELA DE RANKING -->
        <div id="ranking-screen" class="hidden bg-gray-800 p-8 rounded-2xl shadow-2xl">
            <h1 class="text-4xl font-bold text-yellow-400 mb-6 text-center">Ranking dos Aventureiros</h1>
            <div id="ranking-table" class="space-y-4"></div>
            <div class="text-center mt-8">
                 <button id="back-to-menu-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Voltar</button>
            </div>
        </div>

        <!-- MODAL DE QUIZ (Reutiliz√°vel) -->
        <div id="quiz-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-3xl w-full shadow-2xl border-2 border-gray-700">
                <h3 id="question-text" class="text-2xl md:text-3xl font-bold text-center mb-6"></h3>
                <div id="options-container" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                <div id="feedback-message" class="text-center text-2xl font-bold mt-6 h-8"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'estacao-jogos-fracoes';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function signInFirebase() {
            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (error) { console.error("Firebase auth error:", error); }
        }
        signInFirebase();
        
        // --- GERENCIADOR DE ESTADO E UI ---
        const state = { playerName: "", currentScreen: "login" };
        const screens = {
            login: document.getElementById('login-screen'),
            mainMenu: document.getElementById('main-menu-screen'),
            tabuleiro: document.getElementById('tabuleiro-screen'),
            calculadora: document.getElementById('calculadora-screen'),
            batalha: document.getElementById('batalha-screen'),
            ranking: document.getElementById('ranking-screen'),
        };

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
            state.currentScreen = screenName;
        }

        // --- L√ìGICA PRINCIPAL E EVENTOS ---
        document.getElementById('login-btn').addEventListener('click', () => {
            const name = document.getElementById('player-name-input').value.trim();
            if (name) {
                state.playerName = name;
                document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${state.playerName}! Escolha seu desafio:`;
                switchScreen('mainMenu');
            } else { alert("Por favor, digite seu nome!"); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => {
            state.playerName = "";
            document.getElementById('player-name-input').value = "";
            switchScreen('login');
        });
        document.getElementById('show-ranking-btn-login').addEventListener('click', () => {
             switchScreen('ranking');
             loadRanking();
        });
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            switchScreen(state.playerName ? 'mainMenu' : 'login');
        });

        // --- INICIALIZADORES DE JOGOS ---
        document.getElementById('start-tabuleiro').addEventListener('click', () => initTabuleiro());
        document.getElementById('start-calculadora').addEventListener('click', () => initCalculadora());
        document.getElementById('start-batalha').addEventListener('click', () => initBatalha());
        
        // --- [ C√ìDIGO DO JOGO DE TABULEIRO ] ---
        const tabuleiroState = {
            BOARD_SPACES: 20, position: 0, score: 0,
            path: [
                {x: 10, y: 85}, {x: 30, y: 85}, {x: 50, y: 85}, {x: 70, y: 85}, {x: 90, y: 85}, {x: 90, y: 65}, {x: 70, y: 65}, {x: 50, y: 65}, {x: 30, y: 65}, {x: 10, y: 65}, {x: 10, y: 45}, {x: 30, y: 45}, {x: 50, y: 45}, {x: 70, y: 45}, {x: 90, y: 45}, {x: 90, y: 25}, {x: 70, y: 25}, {x: 50, y: 25}, {x: 30, y: 25}, {x: 10, y: 25},
            ]
        };
        
        function initTabuleiro() {
            tabuleiroState.position = 0;
            tabuleiroState.score = 0;
            screens.tabuleiro.innerHTML = `<div class="flex flex-col h-full bg-gray-900 rounded-2xl p-4"><div class="flex-shrink-0 flex justify-between items-center mb-4 px-4"><h2 class="text-xl md:text-2xl font-bold text-blue-300">Jogador: ${state.playerName}</h2><div class="text-right text-lg"><p>Posi√ß√£o: <span id="tabuleiro-position" class="font-bold text-white">0</span></p><p>Acertos: <span id="tabuleiro-score" class="font-bold text-white">0</span></p></div></div><div id="game-board" class="flex-grow game-board-bg w-full bg-gray-800 rounded-lg p-4 relative shadow-inner aspect-video"></div><div class="flex-shrink-0 flex justify-center items-center gap-8 mt-6"><div class="dice-container"><div id="dice" class="dice"><div class="dice-face face-1">1</div><div class="dice-face face-2">2</div><div class="dice-face face-3">3</div><div class="dice-face face-4">4</div><div class="dice-face face-5">5</div><div class="dice-face face-6">6</div></div></div><button id="dice-roll-btn" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-10 rounded-lg text-2xl shadow-lg">Lan√ßar Dado</button></div><button class="back-btn mt-6 text-gray-400 hover:text-white mx-auto block">Voltar ao Menu</button></div>`;
            drawBoard();
            document.getElementById('dice-roll-btn').onclick = rollDice;
            screens.tabuleiro.querySelector('.back-btn').onclick = () => switchScreen('mainMenu');
            switchScreen('tabuleiro');
        }
        function drawBoard() {
            const boardElement = document.getElementById('game-board');
            boardElement.innerHTML = '';
            let pathSVG = '<svg class="absolute inset-0 w-full h-full"><path d="';
            tabuleiroState.path.forEach((p, i) => { const command = i === 0 ? 'M' : 'L'; pathSVG += `${command} ${p.x}% ${p.y}% `; });
            pathSVG += '" stroke="#4a5568" stroke-width="12" fill="none" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="1 20"/></svg>';
            boardElement.innerHTML += pathSVG;
            tabuleiroState.path.forEach((pos, i) => {
                 const spaceIndex = i + 1;
                 const space = document.createElement('div');
                 space.className = 'absolute flex items-center justify-center w-12 h-12 bg-gray-800 text-white font-bold rounded-full border-4 border-blue-400 shadow-xl';
                 space.style.left = `${pos.x}%`; space.style.top = `${pos.y}%`; space.style.transform = 'translate(-50%, -50%)';
                 space.textContent = spaceIndex;
                 if(spaceIndex === tabuleiroState.BOARD_SPACES) { space.classList.remove('bg-gray-800', 'border-blue-400'); space.classList.add('bg-yellow-500', 'border-yellow-300', 'text-gray-900'); space.innerHTML = 'üèÜ'; }
                 boardElement.appendChild(space);
            });
            const playerPiece = document.createElement('div');
            playerPiece.id = 'player-piece';
            playerPiece.className = 'player-piece absolute w-10 h-10 bg-red-500 rounded-full border-4 border-white shadow-lg flex items-center justify-center';
            playerPiece.innerHTML = '<div class="w-4 h-4 bg-white rounded-full opacity-75"></div>';
            boardElement.appendChild(playerPiece);
            movePlayerPiece(0);
        }
        function movePlayerPiece(position) {
            const piece = document.getElementById('player-piece');
            if(!piece) return;
            const pos = position === 0 ? {x: 10, y: 95} : tabuleiroState.path[position - 1];
            piece.style.left = `${pos.x}%`; piece.style.top = `${pos.y}%`;
            document.getElementById('tabuleiro-position').textContent = position;
        }
        function rollDice() {
            const dice = document.getElementById('dice');
            const diceBtn = document.getElementById('dice-roll-btn');
            diceBtn.disabled = true;
            const result = Math.floor(Math.random() * 6) + 1;
            const randomX = (Math.floor(Math.random() * 4) + 4) * 90;
            const randomY = (Math.floor(Math.random() * 4) + 4) * 90;
            dice.style.transform = `rotateX(${randomX}deg) rotateY(${randomY}deg)`;
            setTimeout(() => {
                const rotation = { 1: 'rotateY(0deg)', 2: 'rotateY(-90deg)', 3: 'rotateY(-180deg)', 4: 'rotateY(90deg)', 5: 'rotateX(-90deg)', 6: 'rotateX(90deg)' };
                dice.style.transition = 'transform 0.5s';
                dice.style.transform = rotation[result];
            }, 1000);
            setTimeout(() => { dice.style.transition = 'transform 1s'; showQuiz(result); }, 2000);
        }
        function showQuiz(diceResult) {
            const questions = [ { text: "Qual imagem representa 1/2?", fraction: [1, 2] }, { text: "Qual imagem representa 1/4?", fraction: [1, 4] }, { text: "Qual imagem representa 3/4?", fraction: [3, 4] }, { text: "Qual imagem representa 2/3?", fraction: [2, 3] }, { text: "Qual imagem representa 1/3?", fraction: [1, 3] }, { text: "Qual imagem representa 2/5?", fraction: [2, 5] }];
            const question = questions[Math.floor(Math.random() * questions.length)];
            document.getElementById('question-text').textContent = question.text;
            const options = [question.fraction];
            while (options.length < 4) {
                const randomFraction = questions[Math.floor(Math.random() * questions.length)].fraction;
                if (!options.some(opt => opt[0] === randomFraction[0] && opt[1] === randomFraction[1])) options.push(randomFraction);
            }
            options.sort(() => Math.random() - 0.5);
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            options.forEach(opt => {
                const isCorrect = opt[0] === question.fraction[0] && opt[1] === question.fraction[1];
                const card = document.createElement('div');
                card.className = 'option-card bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-transparent transition-transform duration-200';
                card.innerHTML = createFractionSVG(opt[0], opt[1]);
                card.onclick = () => handleQuizAnswer(isCorrect, diceResult);
                optionsContainer.appendChild(card);
            });
            document.getElementById('feedback-message').textContent = '';
            document.getElementById('quiz-modal').classList.remove('hidden');
        }
        function createFractionSVG(numerator, denominator, size = 100) {
            const rectWidth = size / denominator;
            let svg = `<svg width="${size}" height="${size/2}" viewBox="0 0 ${size} ${size/2}" class="mx-auto">`;
            for (let i = 0; i < denominator; i++) {
                const isFilled = i < numerator;
                svg += `<rect x="${i * rectWidth}" y="0" width="${rectWidth}" height="${size/2}" fill="${isFilled ? '#4299e1' : '#4a5568'}" stroke="#e2e8f0" stroke-width="2"/>`;
            }
            svg += `</svg>`; return svg;
        }
        function handleQuizAnswer(isCorrect, diceResult) {
            const feedback = document.getElementById('feedback-message');
             if (isCorrect) {
                feedback.textContent = "Correto! ‚úÖ"; feedback.classList.add('text-green-500');
                tabuleiroState.score++; document.getElementById('tabuleiro-score').textContent = tabuleiroState.score;
                tabuleiroState.position = Math.min(tabuleiroState.BOARD_SPACES, tabuleiroState.position + diceResult);
             } else {
                feedback.textContent = "Errado! ‚ùå"; feedback.classList.add('text-red-500');
             }
             document.querySelectorAll('.option-card').forEach(c => c.onclick = null);
             setTimeout(() => {
                document.getElementById('quiz-modal').classList.add('hidden');
                movePlayerPiece(tabuleiroState.position);
                if (tabuleiroState.position >= tabuleiroState.BOARD_SPACES) { endTabuleiroGame(); } else { document.getElementById('dice-roll-btn').disabled = false; }
             }, 1500);
        }
        async function endTabuleiroGame() {
            alert(`Parab√©ns, ${state.playerName}! Voc√™ concluiu a Aventura com ${tabuleiroState.score} acertos!`);
            await saveScore(tabuleiroState.score, 'tabuleiro');
            switchScreen('mainMenu');
        }
        
        // --- [ C√ìDIGO DA CALCULADORA NINJA ] ---
        const calculadoraState = { timer: 60, score: 0, interval: null, currentAnswer: { n: 0, d: 1 } };
        
        function initCalculadora() {
            screens.calculadora.innerHTML = `<div id="calculadora-start" class="text-center"><h1 class="text-4xl font-bold text-green-400 mb-4">Calculadora Ninja</h1><p class="text-xl text-gray-400 mb-8">Resolva o m√°ximo de opera√ß√µes que conseguir em 60 segundos!</p><button id="start-calculadora-btn" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-10 rounded-lg text-2xl shadow-lg">Come√ßar!</button><button class="back-btn-calc mt-8 text-gray-400 hover:text-white mx-auto block">Voltar ao Menu</button></div><div id="calculadora-game" class="hidden flex flex-col items-center"><div class="w-full flex justify-between text-2xl font-bold mb-8"><div>Tempo: <span id="timer-display" class="text-yellow-400">60</span>s</div><div>Pontos: <span id="score-display" class="text-green-400">0</span></div></div><div id="operation-display" class="bg-gray-800 rounded-lg p-8 w-full max-w-md text-center mb-8 shadow-inner"><p class="text-5xl font-bold">1/2 + 1/4</p></div><form id="answer-form" class="w-full max-w-sm flex gap-4"><input type="text" id="answer-input" placeholder="ex: 3/4" class="flex-grow bg-gray-700 border-2 border-gray-600 text-white text-center text-xl rounded-lg p-3 focus:outline-none focus:border-green-500"><button type="submit" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-xl">Verificar</button></form></div><div id="calculadora-end" class="hidden text-center"><h1 class="text-4xl font-bold text-green-400 mb-4">Tempo Esgotado!</h1><p class="text-2xl mb-8">Voc√™ fez <span id="final-score" class="font-bold text-white">0</span> pontos!</p><button class="play-again-btn-calc btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Jogar Novamente</button><button class="back-btn-calc mt-4 text-gray-400 hover:text-white mx-auto block">Voltar ao Menu</button></div>`;
            document.getElementById('start-calculadora-btn').onclick = startCalculadoraGame;
            document.querySelectorAll('.back-btn-calc').forEach(btn => btn.onclick = () => switchScreen('mainMenu'));
            document.querySelectorAll('.play-again-btn-calc').forEach(btn => btn.onclick = initCalculadora);
            document.getElementById('answer-form').onsubmit = (e) => { e.preventDefault(); checkNinjaAnswer(); };
            switchScreen('calculadora');
        }
        function startCalculadoraGame() {
            document.getElementById('calculadora-start').classList.add('hidden');
            document.getElementById('calculadora-game').classList.remove('hidden');
            document.getElementById('calculadora-end').classList.add('hidden');
            calculadoraState.score = 0; calculadoraState.timer = 60;
            document.getElementById('score-display').textContent = '0';
            document.getElementById('timer-display').textContent = '60';
            generateNinjaProblem(); document.getElementById('answer-input').focus();
            calculadoraState.interval = setInterval(() => {
                calculadoraState.timer--;
                document.getElementById('timer-display').textContent = calculadoraState.timer;
                if (calculadoraState.timer <= 0) { endCalculadoraGame(); }
            }, 1000);
        }
        function gcd(a, b){ return b === 0 ? a : gcd(b, a % b); }
        function simplifyFraction(n, d){ const common = gcd(Math.abs(n), Math.abs(d)); return { n: n / common, d: d / common }; }
        function generateNinjaProblem() {
            const operations = ['+', '-', '*', '/'];
            const op = operations[Math.floor(Math.random() * operations.length)];
            let n1 = Math.floor(Math.random() * 9) + 1, d1 = Math.floor(Math.random() * 9) + 1;
            let n2 = Math.floor(Math.random() * 9) + 1, d2 = Math.floor(Math.random() * 9) + 1;
            let result;
            if ((op === '+' || op === '-') && d1 === d2) { d2 = Math.floor(Math.random() * 9) + 1; if(d1 === d2) d2++; }
            if (op === '/' && (n1/d1 < n2/d2)) { [n1, n2, d1, d2] = [n2, n1, d2, d1]; }
            switch (op) {
                case '+': result = { n: n1 * d2 + n2 * d1, d: d1 * d2 }; break;
                case '-': result = { n: n1 * d2 - n2 * d1, d: d1 * d2 }; break;
                case '*': result = { n: n1 * n2, d: d1 * d2 }; break;
                case '/': result = { n: n1 * d2, d: d1 * n2 }; break;
            }
            if (result.n <= 0 && op === '-') { return generateNinjaProblem(); }
            calculadoraState.currentAnswer = simplifyFraction(result.n, result.d);
            document.getElementById('operation-display').innerHTML = `<p class="text-5xl font-bold">${n1}/${d1} ${op} ${n2}/${d2}</p>`;
        }
        function checkNinjaAnswer() {
            const input = document.getElementById('answer-input').value.trim();
            const display = document.getElementById('operation-display');
            if (!input.match(/^-?\d+\/\d+$/)) return;
            const [n_str, d_str] = input.split('/');
            const userAnswer = { n: parseInt(n_str), d: parseInt(d_str) };
            if(userAnswer.d === 0) return;
            const simplifiedUserAnswer = simplifyFraction(userAnswer.n, userAnswer.d);
            const { n, d } = calculadoraState.currentAnswer;
            if (simplifiedUserAnswer.n === n && simplifiedUserAnswer.d === d) {
                calculadoraState.score++; display.classList.add('correct-answer');
            } else { display.classList.add('wrong-answer'); }
            setTimeout(() => { display.classList.remove('correct-answer', 'wrong-answer'); }, 500);
            document.getElementById('score-display').textContent = calculadoraState.score;
            document.getElementById('answer-input').value = '';
            generateNinjaProblem();
        }
        async function endCalculadoraGame() {
            clearInterval(calculadoraState.interval);
            document.getElementById('calculadora-game').classList.add('hidden');
            document.getElementById('calculadora-end').classList.remove('hidden');
            document.getElementById('final-score').textContent = calculadoraState.score;
            await saveScore(calculadoraState.score, 'calculadora');
        }

        // --- [ C√ìDIGO DA BATALHA DE FRA√á√ïES ] ---
        const batalhaState = {
            playerHP: 100, monsterHP: 100, maxHP: 100,
            score: 0, turnLocked: false, currentQuestion: null,
        };
        function initBatalha() {
            batalhaState.playerHP = 100;
            batalhaState.monsterHP = 100;
            batalhaState.score = 0;
            batalhaState.turnLocked = false;
            screens.batalha.innerHTML = `
                <div class="bg-gray-900 rounded-2xl p-4 flex flex-col items-center">
                    <div class="w-full flex justify-between items-end mb-4 px-4">
                        <div id="player-area" class="text-center w-40">
                            <div id="player-sprite" class="character h-24 mx-auto"><svg viewBox="0 0 50 100"><circle cx="25" cy="25" r="15" fill="#4299e1"/><path d="M25 40 V 70 M 10 95 L 25 70 L 40 95 M 10 55 L 40 55" stroke="#4299e1" stroke-width="5" fill="none"/></svg></div>
                            <h3 class="font-bold text-white text-lg truncate">${state.playerName}</h3>
                            <div class="hp-bar-container w-full h-4 mx-auto mt-2"><div id="player-hp-bar" class="hp-bar bg-green-500 h-full" style="width: 100%;"></div></div>
                            <p class="text-sm text-white">${batalhaState.playerHP}/${batalhaState.maxHP}</p>
                        </div>
                        <div class="text-5xl font-bold text-red-500 pb-10">VS</div>
                        <div id="monster-area" class="text-center w-40">
                            <div id="monster-sprite" class="character h-24 mx-auto"><svg viewBox="0 0 80 80"><path d="M10 80 Q 40 10, 70 80 Z M 25 40 a 5 5 0 1 1 -10 0 a 5 5 0 1 1 10 0 M 65 40 a 5 5 0 1 1 -10 0 a 5 5 0 1 1 10 0 M 20 60 Q 40 50, 60 60" fill="#c53030" stroke="#f56565" stroke-width="3"/></svg></div>
                            <h3 class="font-bold text-white text-lg">Monstro da Matida</h3>
                            <div class="hp-bar-container w-full h-4 mx-auto mt-2"><div id="monster-hp-bar" class="hp-bar bg-red-500 h-full" style="width: 100%;"></div></div>
                            <p class="text-sm text-white">${batalhaState.monsterHP}/${batalhaState.maxHP}</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6 w-full text-center my-4 min-h-[150px]">
                         <h2 id="batalha-question-text" class="text-2xl font-bold mb-4"></h2>
                         <div id="batalha-options" class="flex justify-center flex-wrap gap-4"></div>
                    </div>
                    <p id="action-log" class="text-lg text-yellow-400 h-8 font-semibold"></p>
                    <button class="back-btn-batalha mt-4 text-gray-400 hover:text-white">Voltar ao Menu</button>
                </div>`;
            screens.batalha.querySelector('.back-btn-batalha').onclick = () => switchScreen('mainMenu');
            switchScreen('batalha');
            generateBatalhaProblem();
        }
        function generateBatalhaProblem() {
            let n1 = Math.floor(Math.random() * 9) + 1, d1 = Math.floor(Math.random() * 9) + 2;
            let n2 = Math.floor(Math.random() * 9) + 1, d2 = Math.floor(Math.random() * 9) + 2;
            while(n1/d1 === n2/d2) { n2 = Math.floor(Math.random() * 9) + 1; d2 = Math.floor(Math.random() * 9) + 2; }
            const isGreater = n1/d1 > n2/d2;
            batalhaState.currentQuestion = { f1: {n:n1, d:d1}, f2: {n:n2, d:d2}, answer: isGreater ? 'f1' : 'f2' };
            document.getElementById('batalha-question-text').textContent = "Qual fra√ß√£o √© MAIOR?";
            const optionsContainer = document.getElementById('batalha-options');
            optionsContainer.innerHTML = `<button data-choice="f1" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-2xl">${n1}/${d1}</button><button data-choice="f2" class="btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-lg text-2xl">${n2}/${d2}</button>`;
            optionsContainer.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => handleBatalhaAnswer(btn.dataset.choice);
            });
            batalhaState.turnLocked = false;
        }
        function handleBatalhaAnswer(choice) {
            if(batalhaState.turnLocked) return;
            batalhaState.turnLocked = true;
            const actionLog = document.getElementById('action-log');
            const isCorrect = choice === batalhaState.currentQuestion.answer;
            if (isCorrect) {
                const damage = Math.floor(Math.random() * 16) + 15; // 15-30 damage
                batalhaState.monsterHP = Math.max(0, batalhaState.monsterHP - damage);
                batalhaState.score += damage;
                actionLog.textContent = `Voc√™ acertou e causou ${damage} de dano!`;
                document.getElementById('player-sprite').classList.add('character-attack');
                document.getElementById('monster-sprite').classList.add('character-hit');
            } else {
                const damage = Math.floor(Math.random() * 11) + 10; // 10-20 damage
                batalhaState.playerHP = Math.max(0, batalhaState.playerHP - damage);
                actionLog.textContent = `Voc√™ errou! O monstro causou ${damage} de dano.`;
                document.getElementById('monster-sprite').classList.add('character-attack');
                document.getElementById('player-sprite').classList.add('character-hit');
            }
            updateHPBars();
            setTimeout(() => {
                document.getElementById('player-sprite').classList.remove('character-attack', 'character-hit');
                document.getElementById('monster-sprite').classList.remove('character-attack', 'character-hit');
                actionLog.textContent = "";
                if (batalhaState.playerHP <= 0) { endBatalhaGame(false); } 
                else if (batalhaState.monsterHP <= 0) { endBatalhaGame(true); } 
                else { generateBatalhaProblem(); }
            }, 2000);
        }
        function updateHPBars() {
            document.getElementById('player-hp-bar').style.width = `${(batalhaState.playerHP / batalhaState.maxHP) * 100}%`;
            document.getElementById('monster-hp-bar').style.width = `${(batalhaState.monsterHP / batalhaState.maxHP) * 100}%`;
            document.querySelector('#player-area p').textContent = `${batalhaState.playerHP}/${batalhaState.maxHP}`;
            document.querySelector('#monster-area p').textContent = `${batalhaState.monsterHP}/${batalhaState.maxHP}`;
        }
        async function endBatalhaGame(playerWon) {
            await saveScore(batalhaState.score, 'batalha');
            const message = playerWon
                ? `Voc√™ venceu! O Monstro da Matida foi derrotado! Voc√™ fez ${batalhaState.score} pontos.`
                : `Voc√™ foi derrotado... Mas causou ${batalhaState.score} de dano! Tente novamente!`;
            screens.batalha.innerHTML = `<div class="text-center"><h1 class="text-4xl font-bold ${playerWon ? 'text-green-400' : 'text-red-400'} mb-4">${playerWon ? 'Vit√≥ria!' : 'Fim de Jogo'}</h1><p class="text-xl mb-8">${message}</p><button class="play-again-btn-batalha btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-xl">Jogar Novamente</button><button class="back-btn-batalha mt-4 text-gray-400 hover:text-white mx-auto block">Voltar ao Menu</button></div>`;
            screens.batalha.querySelector('.play-again-btn-batalha').onclick = initBatalha;
            screens.batalha.querySelector('.back-btn-batalha').onclick = () => switchScreen('mainMenu');
        }

        // --- FUN√á√ïES GERAIS (RANKING, ETC.) ---
        async function saveScore(score, gameMode) {
            if (!auth.currentUser) {
                console.error("Usu√°rio n√£o autenticado. N√£o foi poss√≠vel salvar a pontua√ß√£o.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/scores`), {
                    name: state.playerName,
                    score: score,
                    gameMode: gameMode,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Erro ao salvar pontua√ß√£o: ", e); }
        }
        function loadRanking() {
            const q = query(collection(db, `artifacts/${appId}/public/data/scores`), orderBy("score", "desc"), orderBy("timestamp", "asc"));
            const rankingTable = document.getElementById('ranking-table');
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    rankingTable.innerHTML = '<p class="text-center text-gray-400">Ningu√©m jogou ainda. Seja o primeiro!</p>';
                    return;
                }
                rankingTable.innerHTML = '';
                let rank = 1;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const entry = document.createElement('div');
                    entry.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                    const gameModeText = { tabuleiro: 'Aventura', calculadora: 'Ninja', batalha: 'Batalha' };
                    entry.innerHTML = `<div><p class="font-bold text-lg">${rank}. ${data.name}</p><p class="text-sm text-gray-400">Modo: ${gameModeText[data.gameMode] || 'Desconhecido'}</p></div><span class="text-yellow-400 font-bold text-xl">${data.score} Pontos</span>`;
                    rankingTable.appendChild(entry);
                    rank++;
                });
            });
        }
    </script>
</body>
</html>

